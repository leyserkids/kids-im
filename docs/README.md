# OpenIM 技术文档

本目录包含 OpenIM 即时通讯系统的核心设计分析文档。

---

## 文档索引

| # | 文档 | 说明 |
|---|------|------|
| 01 | [数据库设计分析](01-database-design.md) | MongoDB 分片存储、Seq 机制、客户端 SQLite 设计 |
| 02 | [Seq 序列号设计](02-seq-design.md) | 消息全局有序、增量同步、分片存储的核心机制 |
| 03 | [用户鉴权体系](03-auth-system.md) | JWT Token + Redis 状态管理、多设备登录策略 |
| 04 | [消息顺序与去重](04-message-order-dedup.md) | 5 层保序机制、4 层去重防护 |
| 05 | [消息搜索设计](05-message-search.md) | 服务端 MongoDB 搜索 + 客户端 SQLite 本地搜索 |
| 06 | [REST 与 WebSocket 设计](06-rest-websocket.md) | 双通道架构、数据流分析、设计取舍 |
| 07 | [Redis Token 存储方案](07-redis-token-storage.md) | String vs Hash 对比、TTL 刷新策略 |
| 08 | [消息保留策略](08-message-retention.md) | minSeq 机制、时间/数量限制、Cron 清理 |
| 09 | [消息已读设计](09-read-receipt.md) | ReadCursor、allReadSeq、已读回执同步 |
| 10 | [免打扰设计](10-do-not-disturb.md) | DND 过滤、@mention 绕过、Webhook 层实现 |

---

## 推荐阅读顺序

### 入门路径

1. **01-数据库设计** → 了解整体数据存储架构
2. **02-Seq 设计** → 理解消息排序的核心机制
3. **06-REST/WebSocket** → 了解通信架构

### 深入路径

4. **03-鉴权体系** → Token 管理和多设备登录
5. **04-消息顺序与去重** → 分布式环境下的消息可靠性
6. **05-消息搜索** → 双通道搜索策略
7. **07-Redis Token 存储** → 鉴权体系的补充细节
8. **08-消息保留策略** → minSeq 清理机制
9. **09-消息已读设计** → 已读回执和同步策略

---

## 核心架构概览

```
┌─────────────────────────────────────────────────────────┐
│                    客户端 SDK                            │
│  (WebSocket 长连接 + REST API + SQLite 本地存储)         │
└────────────────────────┬────────────────────────────────┘
                         │
┌────────────────────────▼────────────────────────────────┐
│                   API Gateway                            │
│            (Gin HTTP + WebSocket Server)                 │
└────────────────────────┬────────────────────────────────┘
                         │
┌────────────────────────▼────────────────────────────────┐
│                    RPC Services                          │
│  (msg / user / group / friend / auth / conversation)    │
└────────────────────────┬────────────────────────────────┘
                         │
         ┌───────────────┼───────────────┐
         ▼               ▼               ▼
    ┌─────────┐    ┌─────────┐    ┌─────────┐
    │  Redis  │    │ MongoDB │    │  Kafka  │
    │ (缓存)   │    │ (持久化) │    │ (队列)  │
    └─────────┘    └─────────┘    └─────────┘
```

---

## 关键设计理念

| 设计点 | 方案 | 文档 |
|--------|------|------|
| 消息存储 | 按会话分表 + 按 Seq 分片（100条/文档） | 01 |
| 消息排序 | Seq 原子递增 + 5 层保序 | 02, 04 |
| 消息去重 | ClientMsgID + ServerMsgID + Seq + MongoDB 唯一索引 | 04 |
| 消息同步 | 基于 Seq 的增量同步 | 02 |
| 实时通信 | WebSocket 双向通信 | 06 |
| 管理操作 | REST API 无状态请求 | 06 |
| Token 管理 | JWT + Redis Hash 存储 | 03, 07 |
| 多设备登录 | 4 种策略可配置 | 03 |
| 消息保留 | minSeq 指针 + 时间/数量限制 | 08 |
| 消息已读 | ReadCursor + allReadSeq 计算 | 09 |
| 免打扰 | Webhook 层过滤 + @mention 绕过 | 10 |
